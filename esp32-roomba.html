<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomba Control Interface</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            position: relative;
        }
        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: 50% 20%;
            z-index: 1;
        }
        .background-placeholder {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 1.5em;
            text-align: center;
            z-index: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            position: relative;
            z-index: 2;
        }
        .footer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2px;
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1;
            font-size: 0.8em;
        }
        .footer h3, .footer div, .footer button, .footer select {
            margin: 1px;
        }
        .footer .row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        .footer .row div, .footer .row button, .footer .row select {
            margin: 1px;
        }
        .joystick-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: auto 0 3vh 0;
        }
        .joystick {
            width: 120px;
            height: 120px;
            border: 2px solid #fff;
            border-radius: 50%;
            position: relative;
            touch-action: none;
            margin: 0 10%;
        }
        .joystick-handle {
            width: 40px;
            height: 40px;
            background-color: #007bff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .joystick-vertical {
            width: 60px;
            border-radius: 40px;
        }
        .joystick-horizontal {
            height: 60px;
            border-radius: 40px;
            margin-top: 20px;
        }
        .info-panel {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0px 4px 0px 4px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            font-size: calc(0.4em + 0.3vw);
            max-width: 200px;
        }
        .round-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            cursor: pointer;
            margin: 10px 0;
        }
        .round-buttons-left, .round-buttons-right {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            top: 50%;
            transform: translateY(-50%);
        }
        .round-buttons-left {
            left: 20px;
        }
        .round-buttons-right {
            right: 20px;
        }
        .toggle-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #ipAddress {
            width: 85px;
        }
        #port {
            width: 30px;
        }
        .highlighted {
            background-color: #007bff;
            color: white;
        }
        .non-highlighted {
            background-color: #fff;
            color: #000;
        }
        .connected {
            border: 2px solid green;
        }
        .disconnected {
            border: 2px solid red;
        }
        @media (orientation: portrait) {
            .container {
                flex-direction: column;
            }
            .joystick-container {
                flex-direction: row;
                justify-content: space-around;
                width: 70%;
            }
            .info-panel {
                max-width: 40%;
                font-size: calc(0.5em + 0.3vw);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <img class="background-image" id="backgroundImage">
        <div class="background-placeholder">No video</div>
        <div class="overlay">
            <button class="toggle-button" onclick="toggleImageMode()">ðŸ”²</button>
            <div class="info-panel" id="roombaDataContainer">
                <pre id="roombaData"></pre>
            </div>
            <div class="joystick-container" id="joystickContainer">
                <div id="joystickLeft" class="joystick joystick-vertical">
                    <div class="joystick-handle"></div>
                </div>
                <div id="joystickRight" class="joystick joystick-horizontal">
                    <div class="joystick-handle"></div>
                </div>
            </div>
            <div class="footer" id="controlsContainer">
                <div class="row">
                    <div>
                        <input type="text" id="ipAddress" placeholder="Enter ESP32 IP Address" class="disconnected">
                        <input type="text" id="port" placeholder="81" class="disconnected">
                        <button onclick="connectWebSocket()">Connect</button>
                        <button onclick="disconnectWebSocket()">Disconnect</button>
                    </div>
                </div>
                <div class="row">
                    <button onclick="sendCommand('wakeup')">Wakeup</button>
                    <button onclick="sendCommand('power')">Shutdown</button>
                    <button id="passiveButton" class="non-highlighted" onclick="sendCommand('start')">Passive</button>
                    <button id="safeButton" class="non-highlighted" onclick="sendCommand('safe')">Safe mode</button>
                    <button id="fullButton" class="non-highlighted" onclick="sendCommand('full')">Full mode</button>
                </div>
            </div>
            <div class="round-buttons-left">
                <div class="round-button">A</div>
                <div class="round-button">B</div>
                <div class="round-button">C</div>
            </div>
            <div class="round-buttons-right">
                <div class="round-button">D</div>
                <div class="round-button">E</div>
                <div class="round-button">F</div>
                <div class="round-button">G</div>
            </div>
        </div>
    </div>
    <script>
        var ws;
        var ipAddress;
        var port;
        var leftJoystickState = { x: 0, y: 0 };
        var rightJoystickState = { x: 0, y: 0 };
        var lastGamepadDriveValues = { left: 0, right: 0 };
        var gamepadActive = false;
        var gamepadMode = 1;
        var triggersInitialized = { left: false, right: false };

        var joystickLeft, joystickRight, joystickLeftHandle, joystickRightHandle;

        function connectWebSocket() {
            ipAddress = document.getElementById('ipAddress').value;
            localStorage.setItem('ipAddress', ipAddress);
            port = document.getElementById('port').value || 81;
            if (port != 81) {
                localStorage.setItem('port', port);
            }
            ws = new WebSocket('ws://' + ipAddress + ':' + port);

            ws.onopen = function() {
                console.log('WebSocket connection opened');
                document.getElementById('ipAddress').classList.remove('disconnected');
                document.getElementById('ipAddress').classList.add('connected');
                document.getElementById('port').classList.remove('disconnected');
                document.getElementById('port').classList.add('connected');
            };

            ws.onmessage = function(event) {
                displayRoombaData(event.data);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed');
                document.getElementById('ipAddress').classList.remove('connected');
                document.getElementById('ipAddress').classList.add('disconnected');
                document.getElementById('port').classList.remove('connected');
                document.getElementById('port').classList.add('disconnected');
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                document.getElementById('ipAddress').classList.remove('connected');
                document.getElementById('ipAddress').classList.add('disconnected');
            }
        }

        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(command);
                console.log('Sent command: ' + command);
            } else {
                console.log('WebSocket is not connected');
            }
        }

        function displayRoombaData(data) {
            var roombaDataElement = document.getElementById('roombaData');
            
            var jsonData = JSON.parse(data);
            var text = JSON.stringify(jsonData, null, 2);
            text = text.substring(1, text.length - 1);
            text = text.replace(/  /g, '');
            text = text.substring(text.indexOf('\n') + 1);
            roombaDataElement.textContent = text;

            var mode = jsonData.oi_mode;
            var passiveButton = document.getElementById('passiveButton');
            var safeButton = document.getElementById('safeButton');
            var fullButton = document.getElementById('fullButton');

            // Reset all buttons to non-highlighted
            passiveButton.classList.remove('highlighted');
            passiveButton.classList.add('non-highlighted');
            safeButton.classList.remove('highlighted');
            safeButton.classList.add('non-highlighted');
            fullButton.classList.remove('highlighted');
            fullButton.classList.add('non-highlighted');

            // Highlight the corresponding button based on the mode
            if (mode === 1) {
                passiveButton.classList.remove('non-highlighted');
                passiveButton.classList.add('highlighted');
            } else if (mode === 2) {
                safeButton.classList.remove('non-highlighted');
                safeButton.classList.add('highlighted');
            } else if (mode === 3) {
                fullButton.classList.remove('non-highlighted');
                fullButton.classList.add('highlighted');
            }
        }

        function updateDriveCommand() {
            var leftSpeed = Math.round(leftJoystickState.y * -500 + rightJoystickState.x * 500);
            var rightSpeed = Math.round(leftJoystickState.y * -500 - rightJoystickState.x * 500);

            // Normalize the speeds to ensure they stay within the range of -500 to 500
            var maxSpeed = Math.max(Math.abs(leftSpeed), Math.abs(rightSpeed));
            if (maxSpeed > 500) {
                leftSpeed = (leftSpeed / maxSpeed) * 500;
                rightSpeed = (rightSpeed / maxSpeed) * 500;
            }

            sendCommand('drive_direct ' + leftSpeed + ' ' + rightSpeed);
        }

        function handleJoystickMove(event, joystick, handle, callback, restrictX, restrictY, joystickState) {
            var rect = joystick.getBoundingClientRect();
            var x = (event.touches ? event.touches[0].clientX : event.clientX) - rect.left;
            var y = (event.touches ? event.touches[0].clientY : event.clientY) - rect.top;
            var centerX = rect.width / 2;
            var centerY = rect.height / 2;
            var dx = x - centerX;
            var dy = y - centerY;
            var distance = Math.sqrt(dx * dx + dy * dy);
            var maxDistance = restrictX ? rect.width / 2 : rect.height / 2;

            if (distance > maxDistance) {
                dx = dx * maxDistance / distance;
                dy = dy * maxDistance / distance;
            }

            if (restrictX) dx = Math.min(Math.max(dx, -maxDistance), maxDistance);
            if (restrictY) dy = Math.min(Math.max(dy, -maxDistance), maxDistance);

            if (restrictX) dy = 0; // Ensure no vertical movement for horizontal joystick
            if (restrictY) dx = 0; // Ensure no horizontal movement for vertical joystick

            handle.style.left = (centerX + dx) + 'px';
            handle.style.top = (centerY + dy) + 'px';

            joystickState.x = dx / maxDistance;
            joystickState.y = dy / maxDistance;

            callback(dx / maxDistance, dy / maxDistance);
            updateDriveCommand();
        }

        function handleJoystickEnd(handle, joystickState) {
            handle.style.left = '50%';
            handle.style.top = '50%';
            joystickState.x = 0;
            joystickState.y = 0;
            updateDriveCommand();
        }

        function updateJoystickHandle(joystick, handle, x, y, restrictX, restrictY) {
            var rect = joystick.getBoundingClientRect();
            var centerX = rect.width / 2;
            var centerY = rect.height / 2;
            var maxDistance = rect.width / 2;

            var dx = x * maxDistance;
            var dy = y * maxDistance;

            if (restrictX) dx = 0;
            if (restrictY) dy = 0;

            handle.style.left = (centerX + dx) + 'px';
            handle.style.top = (centerY + dy) + 'px';
        }
        
        function updateGamepad() {
            var gamepads = navigator.getGamepads();
            if (gamepads[0]) {
                var gp = gamepads[0];
                var leftSpeed = 0;
                var rightSpeed = 0;

                if (gamepadMode === 1) {
                    // Mode 1: Triggers for forward/reverse, left joystick for left/right
                    triggersInitialized.left = triggersInitialized.left || gp.axes[4] !== 0;
                    triggersInitialized.right = triggersInitialized.right || gp.axes[5] !== 0;

                    var leftTriggerValue = triggersInitialized.left ? gp.axes[4] : -1;
                    var rightTriggerValue = triggersInitialized.right ? gp.axes[5] : -1;

                    leftSpeed = (leftTriggerValue - rightTriggerValue) * 0.5; // Left trigger - Right trigger
                    rightSpeed = gp.axes[0]; // Left stick horizontal axis
                } else {
                    // Mode 2: Left stick forward/backward, right stick left/right
                    leftSpeed = gp.axes[1]; // Left stick vertical axis
                    rightSpeed = gp.axes[2]; // Right stick horizontal axis
                }

                if (leftSpeed !== lastGamepadDriveValues.left || rightSpeed !== lastGamepadDriveValues.right) {
                    leftJoystickState.y = leftSpeed;
                    rightJoystickState.x = rightSpeed;
                    lastGamepadDriveValues.left = leftJoystickState.y;
                    lastGamepadDriveValues.right = rightJoystickState.x;
                    updateDriveCommand();

                    // Update the joystick handles visually
                    updateJoystickHandle(joystickLeft, joystickLeftHandle, 0, leftJoystickState.y, true, false);
                    updateJoystickHandle(joystickRight, joystickRightHandle, rightJoystickState.x, 0, false, true);
                }
                gamepadActive = true;
            } else {
                gamepadActive = false;
            }
            requestAnimationFrame(updateGamepad);
        }

        function addJoystickListeners(joystick, handle, moveCallback, endCallback, restrictX, restrictY, joystickState) {
            var activeTouchId = null;

            joystick.addEventListener('touchstart', function(event) {
                if (activeTouchId === null) {
                    activeTouchId = event.changedTouches[0].identifier;
                    handleJoystickMove(event.changedTouches[0], joystick, handle, moveCallback, restrictX, restrictY, joystickState);
                    event.preventDefault();
                }
            });

            joystick.addEventListener('touchmove', function(event) {
                for (var i = 0; i < event.changedTouches.length; i++) {
                    if (event.changedTouches[i].identifier === activeTouchId) {
                        handleJoystickMove(event.changedTouches[i], joystick, handle, moveCallback, restrictX, restrictY, joystickState);
                        event.preventDefault();
                        break;
                    }
                }
            });

            joystick.addEventListener('touchend', function(event) {
                for (var i = 0; i < event.changedTouches.length; i++) {
                    if (event.changedTouches[i].identifier === activeTouchId) {
                        handleJoystickEnd(handle, joystickState);
                        endCallback();
                        activeTouchId = null;
                        event.preventDefault();
                        break;
                    }
                }
            });

            joystick.addEventListener('touchcancel', function(event) {
                for (var i = 0; i < event.changedTouches.length; i++) {
                    if (event.changedTouches[i].identifier === activeTouchId) {
                        handleJoystickEnd(handle, joystickState);
                        endCallback();
                        activeTouchId = null;
                        event.preventDefault();
                        break;
                    }
                }
            });

            joystick.addEventListener('mousedown', function(event) {
                handleJoystickMove(event, joystick, handle, moveCallback, restrictX, restrictY, joystickState);
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                event.preventDefault();
            });

            function mouseMoveHandler(event) {
                handleJoystickMove(event, joystick, handle, moveCallback, restrictX, restrictY, joystickState);
                event.preventDefault();
            }

            function mouseUpHandler(event) {
                handleJoystickEnd(handle, joystickState);
                endCallback();
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                event.preventDefault();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            var savedIpAddress = localStorage.getItem('ipAddress');
            if (savedIpAddress) {
                document.getElementById('ipAddress').value = savedIpAddress; // Set saved IP address
            }
            var savedPort = localStorage.getItem('port');
            if (savedPort) {
                document.getElementById('port').value = savedPort; // Set saved port
            }
            
            joystickLeft = document.getElementById('joystickLeft');
            joystickRight = document.getElementById('joystickRight');
            joystickLeftHandle = joystickLeft.querySelector('.joystick-handle');
            joystickRightHandle = joystickRight.querySelector('.joystick-handle');

            addJoystickListeners(joystickLeft, joystickLeftHandle, function(x, y) {
                leftJoystickState.y = y;
            }, function() {
                leftJoystickState.y = 0;
            }, false, true, leftJoystickState); // Restrict X movement

            addJoystickListeners(joystickRight, joystickRightHandle, function(x, y) {
                rightJoystickState.x = x;
            }, function() {
                rightJoystickState.x = 0;
            }, true, false, rightJoystickState); // Restrict Y movement

            window.addEventListener("gamepadconnected", function(e) {
                console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
                    e.gamepad.index, e.gamepad.id,
                    e.gamepad.buttons.length, e.gamepad.axes.length);
                gamepadActive = true;
                requestAnimationFrame(updateGamepad);
            });

            window.addEventListener("gamepaddisconnected", function(e) {
                console.log("Gamepad disconnected from index %d: %s",
                    e.gamepad.index, e.gamepad.id);
                gamepadActive = false;
            });

            const backgroundImage = document.getElementById('backgroundImage');
            backgroundImage.style.objectFit = 'contain';
        });

        function toggleImageMode() {
            const backgroundImage = document.getElementById('backgroundImage');
            if (backgroundImage.style.objectFit === 'contain') {
                backgroundImage.style.objectFit = 'cover';
            } else {
                backgroundImage.style.objectFit = 'contain';
            }
        }
    </script>
</body>
</html>